#!/usr/bin/env bash
# wf-workspace-monitor
#
# Monitors Claude/agent state in tmux panes and updates tab colors.
#   green  = actively working (streaming output)
#   yellow = idle / waiting for user input
#   red    = needs approval (permission prompt)
#
# Runs as a background daemon, started automatically by wf-workspace.
# Monitors all tmux sessions (not just one specific session).
# Kill with: pkill -f wf-workspace-monitor

POLL_INTERVAL=2

# Store previous pane content checksums to detect activity
declare -A PREV_HASH

while true; do
  # Get all active tmux sessions
  sessions="$(tmux list-sessions -F '#{session_name}' 2>/dev/null || true)"

  if [[ -z "$sessions" ]]; then
    sleep 5
    continue
  fi

  while IFS= read -r session; do
    # Iterate over all windows in the session
    for window in $(tmux list-windows -t "$session" -F "#{window_index}" 2>/dev/null); do
      # Capture last 10 lines of pane 0 (the Claude/agent pane)
      content=$(tmux capture-pane -t "$session:$window.0" -p -S -10 2>/dev/null || true)

      if [[ -z "$content" ]]; then
        continue
      fi

      # Determine state based on terminal content patterns
      state="working"
      hash_key="${session}:${window}"

      # Check for approval/permission prompts (red)
      if echo "$content" | grep -qiE '(Allow .+ tool|Do you want to proceed|Approve|allow this|press Enter to confirm|\(y\)|Yes.*No|Allow once|Allow always)'; then
        state="approval"

      # Check for idle/waiting for input (yellow)
      elif echo "$content" | tail -3 | grep -qE '(^>\s*$|â¯\s*$|^\$\s*$|^claude>\s*$|waiting for|Type a message|^Human:)'; then
        state="idle"

      else
        # Check if content changed since last poll (activity detection)
        current_hash=$(echo "$content" | md5 -q 2>/dev/null || echo "$content" | md5sum 2>/dev/null | cut -d' ' -f1)
        prev_hash="${PREV_HASH[$hash_key]:-}"

        if [[ "$current_hash" == "$prev_hash" ]]; then
          state="idle"
        fi

        PREV_HASH[$hash_key]="$current_hash"
      fi

      # Apply tab color based on state
      case $state in
        working)
          tmux set-window-option -t "$session:$window" window-status-style 'fg=green' 2>/dev/null
          tmux set-window-option -t "$session:$window" window-status-current-style 'fg=green,bold,underscore' 2>/dev/null
          ;;
        idle)
          tmux set-window-option -t "$session:$window" window-status-style 'fg=yellow' 2>/dev/null
          tmux set-window-option -t "$session:$window" window-status-current-style 'fg=yellow,bold,underscore' 2>/dev/null
          ;;
        approval)
          tmux set-window-option -t "$session:$window" window-status-style 'fg=red,bold' 2>/dev/null
          tmux set-window-option -t "$session:$window" window-status-current-style 'fg=red,bold,underscore' 2>/dev/null
          ;;
      esac
    done
  done <<< "$sessions"

  sleep "$POLL_INTERVAL"
done
